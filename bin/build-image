#!/bin/bash
DIR=$(dirname `realpath -s "$0"`)

# Found on: https://stackoverflow.com/a/20909045
export $(grep -v '^#' $DIR/../.env | xargs -d '\n')

FILENAME=agx-${AGX_VERSION}-${AGX_DISTRIBUTION}.deb

if [ ! -f $DIR/../${FILENAME} ]; then
    wget -O $DIR/../${FILENAME} \
            https://www.algoryx.se/download/installers/${FILENAME}
    
    if [ $? -ne 0 ]; then

        wget -O $DIR/../${FILENAME} \
            https://www.algoryx.se/download/installers/old/${FILENAME}

        if [ $? -ne 0 ]; then
            echo -e "Fetching agx dynamic failed!"
            rm $DIR/../${FILENAME}; exit 1
        fi
    fi
fi 

if [ ! -f $DIR/../*.lic ]; then
    echo -e "Missing lic file"; exit 1
fi

docker buildx build --tag machine-boom-project \
                    --progress=plain \
                    --build-arg AGX_VERSION=$AGX_VERSION \
                    --build-arg AGX_DISTRIBUTION=$AGX_DISTRIBUTION \
                    $DIR/../